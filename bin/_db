#compdef db

_db_databases() {
  local -a dbs
  dbs=(${(f)"$(psql -Atc "SELECT datname FROM pg_database WHERE datistemplate = false AND datname != 'postgres' ORDER BY datname" postgres 2>/dev/null)"})
  compadd -a dbs
}

_db() {
  local -a commands=(
    'create:Create database, print connection info'
    'c:Create database (alias)'
    'new:Create database (alias)'
    'drop:Drop database'
    'rm:Drop database (alias)'
    'list:List all databases with sizes'
    'ls:List databases (alias)'
    'url:Print DATABASE_URL (pipe-friendly)'
    'u:Print DATABASE_URL (alias)'
    'env:Print .env block'
    'e:Print .env block (alias)'
    'clone:Clone database via createdb -T'
    'cp:Clone database (alias)'
    'reset:Drop + recreate database'
    'redis:Redis connection info'
    'r:Redis info (alias)'
    'info:PG + Redis status overview'
    'i:Status overview (alias)'
    'open:Open in TablePlus'
    'o:Open in TablePlus (alias)'
    'psql:Open psql/pgcli shell'
    'sh:Open shell (alias)'
    'setup:Install/start PG + Redis via brew'
  )

  local -a flags=(
    '--json[JSON output]'
    '-j[JSON output]'
    '--force[Skip confirmations]'
    '-f[Skip confirmations]'
    '--no-color[Disable colored output]'
    '--help[Show help]'
    '-h[Show help]'
  )

  if (( CURRENT == 2 )); then
    _describe 'command' commands
    _arguments $flags
  elif (( CURRENT == 3 )); then
    case "${words[2]}" in
      open|o)
        local -a open_args
        open_args=(
          '--app:Open TablePlus app (no DB selection)'
        )
        _describe 'open args' open_args
        _db_databases
        ;;
      create|c|new|drop|rm|url|u|env|e|reset|psql|sh|clone|cp)
        _db_databases
        ;;
    esac
  elif (( CURRENT == 4 )); then
    case "${words[2]}" in
      clone|cp)
        _db_databases
        ;;
    esac
  fi
}

_db "$@"
