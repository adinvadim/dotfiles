#!/usr/bin/env sh
set -eu

FIRECRAWL_API_KEY="${FIRECRAWL_API_KEY:-}"
SERVER_NAME="firecrawl"

if [ -z "$FIRECRAWL_API_KEY" ]; then
  echo "warning: FIRECRAWL_API_KEY is not set; skipping Firecrawl MCP setup" >&2
  exit 0
fi

setup_codex() {
  command -v codex >/dev/null 2>&1 || return 0

  if codex mcp get "$SERVER_NAME" >/dev/null 2>&1; then
    codex mcp remove "$SERVER_NAME" >/dev/null 2>&1 || true
  fi

  codex mcp add "$SERVER_NAME" --env "FIRECRAWL_API_KEY=$FIRECRAWL_API_KEY" -- npx -y firecrawl-mcp >/dev/null
}

setup_claude() {
  command -v claude >/dev/null 2>&1 || return 0

  if claude mcp get "$SERVER_NAME" >/dev/null 2>&1; then
    claude mcp remove "$SERVER_NAME" -s user >/dev/null 2>&1 || true
  fi

  claude_json="$(printf '{"type":"stdio","command":"npx","args":["-y","firecrawl-mcp"],"env":{"FIRECRAWL_API_KEY":"%s"}}' "$FIRECRAWL_API_KEY")"
  claude mcp add-json -s user "$SERVER_NAME" "$claude_json" >/dev/null
}

setup_opencode() {
  config_home="${XDG_CONFIG_HOME:-$HOME/.config}"
  opencode_config="$config_home/opencode/opencode.json"

  mkdir -p "$(dirname "$opencode_config")"

  if [ ! -f "$opencode_config" ]; then
    cat >"$opencode_config" <<'EOF'
{
  "$schema": "https://opencode.ai/config.json"
}
EOF
  fi

  if command -v jq >/dev/null 2>&1; then
    tmp_file="$(mktemp)"
    jq --arg key "$FIRECRAWL_API_KEY" '
      .mcp = (.mcp // {})
      | .mcp.firecrawl = {
          type: "local",
          command: ["npx", "-y", "firecrawl-mcp"],
          environment: { FIRECRAWL_API_KEY: $key }
        }
    ' "$opencode_config" >"$tmp_file"
    mv "$tmp_file" "$opencode_config"
    return 0
  fi

  node - "$opencode_config" "$FIRECRAWL_API_KEY" <<'NODE'
const fs = require("fs");
const configPath = process.argv[2];
const apiKey = process.argv[3];

let config = {};
try {
  config = JSON.parse(fs.readFileSync(configPath, "utf8"));
} catch (_) {}

if (!config || typeof config !== "object") config = {};
if (!config.mcp || typeof config.mcp !== "object") config.mcp = {};

config.mcp.firecrawl = {
  type: "local",
  command: ["npx", "-y", "firecrawl-mcp"],
  environment: { FIRECRAWL_API_KEY: apiKey },
};

fs.writeFileSync(configPath, JSON.stringify(config, null, 2) + "\n", "utf8");
NODE
}

setup_codex || echo "warning: failed to configure Codex MCP firecrawl" >&2
setup_claude || echo "warning: failed to configure Claude MCP firecrawl" >&2
setup_opencode || echo "warning: failed to configure OpenCode MCP firecrawl" >&2
