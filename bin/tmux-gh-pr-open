#!/usr/bin/env bash
set -euo pipefail

dir="${1:-$PWD}"

if [ ! -d "$dir" ]; then
  exit 0
fi

if ! command -v gh >/dev/null 2>&1; then
  exit 0
fi

if ! git -C "$dir" rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  exit 0
fi

branch="$(git -C "$dir" rev-parse --abbrev-ref HEAD 2>/dev/null || true)"
if [ -z "$branch" ] || [ "$branch" = "HEAD" ]; then
  exit 0
fi

export GH_PAGER=cat
export GH_NO_UPDATE_NOTIFIER=1
export GH_PROMPT_DISABLED=1

url="$(cd "$dir" && gh pr view --json url,state --template '{{if eq .state "OPEN"}}{{.url}}{{end}}' 2>/dev/null || true)"
if [ -z "$url" ]; then
  exit 0
fi

if command -v open >/dev/null 2>&1; then
  open "$url" >/dev/null 2>&1 || true
elif command -v xdg-open >/dev/null 2>&1; then
  xdg-open "$url" >/dev/null 2>&1 || true
fi

exit 0
