#!/usr/bin/env bash
set -euo pipefail

dir="${1:-$PWD}"

if [ ! -d "$dir" ]; then
  exit 0
fi

if ! git -C "$dir" rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  exit 0
fi

branch="$(git -C "$dir" rev-parse --abbrev-ref HEAD 2>/dev/null || true)"
if [ -z "$branch" ] || [ "$branch" = "HEAD" ]; then
  exit 0
fi

if ! command -v gh >/dev/null 2>&1; then
  exit 0
fi

ttl="${TMUX_GH_PR_TTL:-30}"
tmp="${TMPDIR:-/tmp}"
key="$(printf '%s\n' "$dir|$branch" | shasum -a 256 | awk '{print $1}')"
cache="$tmp/tmux-gh-pr-$key"
now="$(date +%s)"

if [ -f "$cache" ]; then
  IFS='|' read -r ts val < "$cache" || true
  if [ -n "${ts:-}" ] && [ $((now - ts)) -lt "$ttl" ]; then
    printf '%s' "${val:-}"
    exit 0
  fi
fi

export GH_PAGER=cat
export GH_NO_UPDATE_NOTIFIER=1
export GH_PROMPT_DISABLED=1

# Get PR info for current branch (any state)
info="$(cd "$dir" && gh pr view --json number,isDraft,state,url \
  --template '{{.number}}{{"\t"}}{{.isDraft}}{{"\t"}}{{.state}}{{"\t"}}{{.url}}' 2>/dev/null || true)"

if [ -z "$info" ]; then
  { printf '%s|' "$now" > "$cache"; } >/dev/null 2>&1 || true
  exit 0
fi

IFS=$'\t' read -r number draft state url <<< "$info"

if [ -z "$number" ] || [ "$number" = "0" ]; then
  { printf '%s|' "$now" > "$cache"; } >/dev/null 2>&1 || true
  exit 0
fi

# Nerd font icon
icon=$(printf '\xEF\x90\x87')  # U+F407 nf-oct-git_pull_request

# Catppuccin Mocha colors per state
case "$state" in
  OPEN)
    if [ "$draft" = "true" ]; then
      color="#f9e2af"  # yellow for draft
    else
      color="#a6e3a1"  # green for open
    fi
    ;;
  MERGED)  color="#cba6f7" ;;  # mauve for merged
  CLOSED)  color="#f38ba8" ;;  # red for closed
  *)       color="#cdd6f4" ;;
esac

label="PR#${number}"
if [ "$draft" = "true" ] && [ "$state" = "OPEN" ]; then
  label="${label}(draft)"
fi

# Colored icon + clickable hyperlink label
val="#[fg=${color}]${icon} #[hyperlink=${url}]${label}#[hyperlink=]"

{ printf '%s|%s' "$now" "$val" > "$cache"; } >/dev/null 2>&1 || true
printf '%s' "$val"
