#FROM DOTBOT
#BINDING
set-option -g prefix C-a

# Terminal & true color
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm-256color:RGB"
set -ag terminal-overrides ",xterm-256color:Smulx=\\E[4::%p1%dm"
set -ag terminal-overrides ",xterm-256color:Setulc=\\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m"
set -ag terminal-features ",xterm-256color:usstyle"

# Extended keys (CSI u)
set -g extended-keys on
set -as terminal-features ",xterm-256color:extkeys"

# Scrollback
set -g history-limit 500000

# Splits with current directory
bind-key v split-window -h -c '#{pane_current_path}'
bind-key b split-window -c '#{pane_current_path}'

## hjkl pane traversal
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Vi copypaste mode
set-window-option -g mode-keys vi
bind-key -T copy-mode-vi 'v' send -X begin-selection
bind-key -T copy-mode-vi 'y' send -X copy-selection-and-cancel

setw -g aggressive-resize on
set -g mouse on
set -g set-clipboard on

# Window numbering
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on

# Display timing
set -g display-panes-time 3000
set -g display-time 3000

# reload config
bind r source-file ~/.tmux.conf \; move-window -r \; display-message "~/.tmux.conf reloaded"

# Mouse: click on the status-right area to open PR
bind-key -n MouseDown1StatusRight run-shell -b '~/bin/tmux-gh-pr-open "#{pane_current_path}"'

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'casonadams/tmux-vi-navigation'
set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'wfxr/tmux-fzf-url' # prefix + u
set -g @plugin 'catppuccin/tmux#v2.1.3'

# System clipboard
set -g @plugin 'tmux-plugins/tmux-yank'

# Quick copy with hints (like Vimium)
set -g @plugin 'fcsonline/tmux-thumbs'

# Scrollback search with fzf
set -g @plugin 'laktak/extrakto'

# Catppuccin config
set -g @catppuccin_flavor 'mocha'
set -g @catppuccin_window_status_style 'none'

run '~/.tmux/plugins/tpm/tpm'

# Custom bindings (after tpm to override plugins)

# Pane resizing
bind -r Left resize-pane -L 5
bind -r Down resize-pane -D 5
bind -r Up resize-pane -U 5
bind -r Right resize-pane -R 5

# Popup windows
bind g display-popup -d '#{pane_current_path}' -w 90% -h 85% -E 'lazygit'
bind G display-popup -d '#{pane_current_path}' -w 90% -h 85% -E 'lazygit log'
bind J display-popup -d '#{pane_current_path}' -w 80% -h 75% -E 'zsh'

# Quick scrollback search
bind / copy-mode \; send-key ?

# Minimal status bar (after tpm to override)
set -g status-left ' #S '
set -g status-right ''

# UI-ish status bar (single line)
set -g status on
set -g status-interval 3

# Base colors (Catppuccin Mocha-ish)
set -g status-style 'bg=#1e1e2e,fg=#cdd6f4'
set -g status-justify left

# Left: session name (plain, to avoid looking like a tab)
set -g status-left-length 30
set -g status-left ' #[fg=#6c7086]tmux:#S#[default]  '

# Right: git + PR pills
set -g status-right-length 160
set -g status-right ' #[fg=#313244,bg=#1e1e2e]#[fg=#cdd6f4,bg=#313244] #(gitmux -cfg ~/.gitmux.conf "#{pane_current_path}")#[bg=#313244]#[fg=#cdd6f4,bg=#313244] #[fg=#313244,bg=#1e1e2e] #[fg=#45475a,bg=#1e1e2e]#[fg=#cdd6f4,bg=#45475a] #(~/bin/tmux-gh-pr "#{pane_current_path}")#[bg=#45475a]#[fg=#cdd6f4,bg=#45475a] #[fg=#45475a,bg=#1e1e2e] '

# Explicit renderer for the status line (some themes/plugins blank status-format)
set -g status-format[0] '#[align=left range=left #{E:status-left-style}]#[push-default]#{T;=/#{status-left-length}:status-left}#[pop-default]#[norange default]#[list=on align=#{status-justify}]#[list=left-marker]<#[list=right-marker]>#[list=on]#{W:#[range=window|#{window_index} #{E:window-status-style}#{?#{&&:#{window_last_flag},#{!=:#{E:window-status-last-style},default}}, #{E:window-status-last-style},}#{?#{&&:#{window_bell_flag},#{!=:#{E:window-status-bell-style},default}}, #{E:window-status-bell-style},#{?#{&&:#{||:#{window_activity_flag},#{window_silence_flag}},#{!=:#{E:window-status-activity-style},default}}, #{E:window-status-activity-style},}}]#[push-default]#{T:window-status-format}#[pop-default]#[norange default]#{?loop_last_flag,,#{window-status-separator}},#[range=window|#{window_index} list=focus #{?#{!=:#{E:window-status-current-style},default},#{E:window-status-current-style},#{E:window-status-style}}#{?#{&&:#{window_last_flag},#{!=:#{E:window-status-last-style},default}}, #{E:window-status-last-style},}#{?#{&&:#{window_bell_flag},#{!=:#{E:window-status-bell-style},default}}, #{E:window-status-bell-style},#{?#{&&:#{||:#{window_activity_flag},#{window_silence_flag}},#{!=:#{E:window-status-activity-style},default}}, #{E:window-status-activity-style},}}]#[push-default]#{T:window-status-current-format}#[pop-default]#[norange list=on default]#{?loop_last_flag,,#{window-status-separator}}}#[nolist align=right range=right #{E:status-right-style}]#[push-default]#{T;=/#{status-right-length}:status-right}#[pop-default]#[norange default]'

# Keep status-format[1] unset
set -gu status-format[1]

# Name windows by current directory (not by running program)
set -g allow-rename off
set -g automatic-rename on
set -g automatic-rename-format '#{b:pane_current_path}'

# Window tabs: project directory only (fixed width) + pill styling
set -g window-status-separator ' '
set -g window-status-format '#[fg=#313244,bg=#1e1e2e]#[fg=#a6adc8,bg=#313244] #(~/bin/tmux-ai-status #{window_id} #{window_active} type) #[fg=#a6adc8,bg=#313244]#{=18:#{b:pane_current_path}}#[fg=#585b70]#(~/bin/tmux-subscript #{window_index}) #[fg=#a6adc8,bg=#313244]#(~/bin/tmux-ai-status #{window_id} #{window_active} status) #[fg=#313244,bg=#1e1e2e]'
set -g window-status-current-format '#[fg=#89b4fa,bg=#1e1e2e]#[fg=#11111b,bg=#89b4fa,bold] #(~/bin/tmux-ai-status #{window_id} #{window_active} type) #[fg=#11111b,bg=#89b4fa,bold]#{=18:#{b:pane_current_path}}#[fg=#313244]#(~/bin/tmux-subscript #{window_index}) #[fg=#11111b,bg=#89b4fa,bold]#(~/bin/tmux-ai-status #{window_id} #{window_active} status) #[fg=#89b4fa,bg=#1e1e2e]'

# These are mostly overridden by explicit styles in window-status-*-format.
set -g window-status-current-style 'fg=#cdd6f4,bg=#45475a'
set -g window-status-style 'fg=#6c7086'
